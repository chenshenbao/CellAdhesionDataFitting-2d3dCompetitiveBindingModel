
close all;
clear;
clc;

%% 
global data tseq k0 SE ac c0 c r0 ks T ml0 mr0 V acr NA kappa kf2 kr2 kf3 kr3 m n

%% experimental data(PMA-Jurkat-1,PMA-Jurkat-2,PMA-PMN,fmlp-PMN,IL-8-PMN)
stitle = repmat({'PMA-Jurkat-1','PMA-Jurkat-2','PMA-PMN','fmlp-PMN','IL-8-PMN'},5,1);% suptitle
sstitle = repmat({'SSH0';'SSH1';'SSH2';'SSH3';'SSH4'},1,5);% subsupertitle
% contact time sequence
tt = {
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0.1	0.25	0.5	0.75	1	2	4	7]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    [0 	0.25	1	4]
    };
% adhesion probability data
dd = {
[0.104184952	0.104622975	0.122562601	0.129762908	0.166768821	0.195200433	0.211381592	0.221739353]
[0.056552241	0.116313984	0.143484271	0.140060618	0.094404069	0.134615756	0.193179781	0.159276648]
[0.060864641	0.091395162	0.125940254	0.125263852	0.091630674	0.144606476	0.216016548	0.167728548]
[0.080886365	0.057166924	0.116817478	0.083687943	0.101636457	0.080670439	0.173560319	0.171196018]
[0.055240228	0.036895268	0.105235467	0.064208783	0.038449183	0.077956524	0.096209525	0.114566943]
    [0.109447175	0.123653328	0.121133651	0.191321483	0.264966337	0.330996132	0.243805745	0.274143738]
    [0.117823188	0.047619048	0.177692335	0.127102408	0.17798056	0.184558084	0.201187616	0.191982131]
    [0.039403036	0.018501558	0.082733765	0.126272567	0.140952966	0.123927413	0.204568437	0.133649314]
    [0.044508212	0.02437267	0.105888174	0.099470167	0.127138674	0.124453368	0.13958382	0.161784851]
    [0.069147599	0.040895289	0.046001244	0.051196519	0.085791697	0.059398988	0.081385476	0.139157081]
[0.15952884     0.164418798	0.234032476	0.221672232	0.261718252	0.233993808	0.237533463	0.20374218]
[0.068949958	0.145186127	0.16825773	0.126973973	0.204786241	0.128012575	0.280406757	0.143270549]
[0.080880906	0.1231636	0.158519862	0.10175312	0.130455177	0.123209848	0.141811445	0.120229761]
[0.052705736	0.087899406	0.095522541	0.070671252	0.123349189	0.08157318	0.120076794	0.11397676]
[0.037932693	0.079213184	0.117592371	0.09005587	0.121665294	0.10381679	0.102238848	0.050254292]
    [0 0.169206	0.191451	0.212885]
    [0 0.109166	0.162479	0.177307]
    [0 0.091056	0.129363	0.109825]
    [0 0.089089	0.109728	0.086204]
    [0 0.043881	0.057708	0.05792]
[0 0.172621	0.271384	0.27188]
[0 0.192142	0.188193	0.265732]
[0 0.138851	0.16405     0.170611]
[0 0.123464	0.137298	0.160757]
[0 0.083779 0.118794 	0.150085]
};
%SE of adhesion data
ss = {
[0.024192421	0.022686071	0.016131788	0.032133291	0.033588886	0.035563897	0.037534452	0.025347195]
[0.018851346	0.010453073	0.041388131	0.024249922	0.019081193	0.029876196	0.034349044	0.029980799]
[0.012103967	0.020363006	0.03911661	0.036041975	0.027088774	0.033549882	0.027901115	0.027030157]
[0.017520981	0.012938151	0.041297528	0.037598266	0.042582734	0.013267335	0.024350247	0.052093824]
[0.008451714	0.021610969	0.014253016	0.027431832	0.017638388	0.01268061	0.026288965	0.031128962]			
    [0.02655448	0.038016109	0.032781676	0.016067755	0.038431299	0.04718493	0.034386212	0.070636932]
    [0.027813688	0.025738443	0.054203189	0.026141477	0.043721714	0.030149024	0.018473272	0.014922329]
    [0.012925098	0.008343871	0.017336397	0.029231071	0.032796784	0.014815555	0.041443516	0.014294259]
    [0.005037896	0.009527415	0.024561345	0.024083488	0.032652991	0.020405468	0.037610995	0.030790648]
    [0.005766948	0.009891113	0.024123038	0.007618219	0.02002534	0.018126289	0.022154902	0.026226278]
[0.026837154	0.043335927	0.018935206	0.02825396	0.036320866	0.030963446	0.034665206	0.039718324]
[0.011913435	0.022777714	0.030828447	0.024253517	0.053883582	0.01689687	0.033729536	0.02449525]
[0.019717363	0.034947579	0.039727245	0.01877405	0.021239467	0.031640429	0.031773467	0.026288829]
[0.015489381	0.021924886	0.013615194	0.010688048	0.030682576	0.021727803	0.034273812	0.029769917]
[0.005776959	0.024232251	0.027218194	0.018295287	0.03263652	0.025280903	0.023259561	0.013243786]
    [0.001	0.017461859	0.023522753	0.028107822]
    [0.001	0.019990353	0.03458329	0.009758333]
    [0.001	0.026942979	0.030151941	0.013573898]
    [0.001	0.026439978	0.041078437	0.008566309]
    [0.001	0.014060534	0.02036255	0.010482201]
[0.001	0.024552407	0.065985889	0.044771469]
[0.001	0.032959591	0.030856851	0.051146222]
[0.001	0.026672265	0.042486348	0.022111495]
[0.001	0.011819234	0.031922133	0.03865006]
[0.001	0.016125194	0.029085867	0.035310499]
};

% soluble PL1 density, Mol/L
cc = zeros(25,1);
% molecule density,[mr,ml], [psgl-1, L-selectin], molecules/um2.
% (PSGL-1 ON HL60 64,PL-1 ON RBC 50).
mm = [repmat([46 77.6],5,1);repmat([46 77.6],5,1);repmat([46 41.6],5,1);repmat([46 41.6],5,1);repmat([46 41.6],5,1)];

aa = repmat(5,25,1);% % contact surface area,um2
RR = [repmat(0.2,5,1);repmat(0.2,5,1);repmat(0.47,5,1);repmat(0.43,5,1);repmat(0.35,5,1)];% [RR KK]shedding constant, [PMA-Jurkat (0.2/0.19) PMA-PMN (0.47/0.27) FMLP-PMN (0.43/0.14) IL8-PMN (0.35/0.13)  ]
KK = [repmat(0.19,5,1);repmat(0.19,5,1);repmat(0.27,5,1);repmat(0.14,5,1);repmat(0.13,5,1)]./60;
TT = 60.*(repmat([0,[15,30,45,60]-7.5]',5,1));% shedding time, middle points of SS1-SS4, s
%% 

NA = 6.02e23;         % Avogadro constant
V0 = 1e-3;            % chamber volume, Litre
nc = 1e3;             % cell number

rRBC = 3;             % RBC radius
rTC = 3;              % T cell radius
acl = 4*pi*rTC^2;     % T cell area,um2
acr = 4*pi*rRBC^2;    % RBC area,um2
d = 500e-9;           % contact distance

% set initial and searching range of reaction parameters 
% - kf2 -- kr2 --- kf3 -- kr3 %
k1 = [1   ,   1,     1 ,      1   ]; % initial value for para searching
lb = [1e-8,   1e-1,  1e3,     1e-4]; % lower limits for para searching
ub = [1e-2,   1e2,   1e6,     1e2 ]; % upper limits for para searching

%% 
for jj = 1:size(tt,1)

tseq = tt{jj}';
data = dd{jj}';
SE = ss{jj}';
ac = aa(jj);
c0 = cc(jj);           % soluble molecule initial concentration (mol/L)
mr0 = mm(jj,1);
ml0 = mm(jj,2);
V = ac*d*1e-9;        % space volumn between contact surfaces, in unit of Litre
r0 = RR(jj) ; ks = KK(jj);   % shedding parameters %[IL8-PMN (0.35/0.13)  PMA-PMN (0.47/0.27) FMLP-PMN (0.43/0.14)PMA-Jurkat (0.2/0.19)]
T = TT(jj);                  % shedding time, s
c = c0 + ml0*acl*nc*(1-r0)*(1-exp(-ks*T))/(NA*V0);
figure(jj);set(gcf,'outerposition',get(0,'screensize'));
spi=1;
        fout = 'result.txt';
        fid = fopen(fout,'a');
        fprintf(fid,'mol stage r0 ks T c m n kf2 kr2 kf3 kr3 kappa^2\n');
        fclose(fid);
% set initial parameters
for i = [-3 -5]      % set different initial value of kf2
    for j = [0 1]    % set different initial value of kf3
        for x = 3
            for y = 1
                k0 = k1.*[10^(i), 10^(j), 10^(x), 10^(y)];
                figure(jj);
                subplot(2,2,spi);
                
                % call  DeltaP.m to calculate difference between theretical  probability value and experimental value,use lsqnonlin() to estimate the best parameters.
                options = optimoptions(@lsqnonlin,'Algorithm','levenberg-marquardt' ,'Display','iter');
                k = lsqnonlin('DeltaP',k0,lb,ub);
                fid = fopen(fout,'a');
                fprintf(fid,'%s %s %f %f %f %f %d %d %f %f %f %f %f\n',stitle{jj},sstitle{jj}, r0,ks,T,c,m,n ,kf2,kr2,kf3,kr3,kappa);
                fclose(fid);
                spi = spi+1;
            end
        end
        
    end
end
% notes on figure
tex = { ['\bf- kf2 -'],['\bf- kr2 -'],['\bf- kf3 -'],['\bf- kr3 -']
        [num2str(ub(1),'%.0e') ],[num2str(ub(2),'%.0e') ],[num2str(ub(3),'%.0e') ],[num2str(ub(4),'%.0e') ]
        [num2str(lb(1),'%.0e') ],[num2str(lb(2),'%.0e') ],[num2str(lb(3),'%.0e') ],[num2str(lb(4),'%.0e') ]
       };
        
[texN,texM]=size(tex);
tmp = get(gca);                                             
x = tmp.XLim;  dx = x(2)-x(1); y = tmp.YLim;  dy = y(2)-y(1);   
texX = x(1) + dx*linspace(0.6,0.9,texM);texY = y(1) + dy*linspace(0.7,0.5,texN);
[posx,posy] = meshgrid(texX, texY);
text(posx(:),posy(:),tex,'Fontsize',9);    
suptitle(['\bfRealTimeShedding- ',stitle{jj},' - ',sstitle{jj}]);
saveas(gcf,[num2str(jj),stitle{jj},'-',sstitle{jj},'.fig']);
end
